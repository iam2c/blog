# 0x01 写在前面
前些日子，在部门技术沙龙中，我分享了本文中的一些内容，今天写这篇文章，并不是为了解释TCP的三次握手原理，而是想通过这篇文章传播这样的信息：思想很重要，我们不仅要了解它的原理，更要把它的思想用到其他实践中。很多核心的东西（比如操作系统底层），它的很多思想永远是值得借鉴的，俗话说：万变不离其宗。

# 0x02 TCP的三次握手
我们先来看看[百度百科](http://baike.baidu.com/subview/32754/8048820.htm)是怎么说的：

TCP是因特网中的传输层协议，使用三次握手协议建立连接。当主动方发出SYN连接请求后，等待对方回答SYN+ACK，并最终对对方的 SYN 执行 ACK 确认。这种建立连接的方法可以防止产生错误的连接，TCP使用的流量控制协议是可变大小的滑动窗口协议。

TCP三次握手的过程如下：
![image](https://github.com/iam2c/blog/blob/master/assets/29381f30e924b899cb32f6316e061d950a7bf6a9.jpg?raw=true)

1. 客户端发送SYN（SEQ=x）报文给服务器端，进入SYN_SEND状态。
2. 服务器端收到SYN报文，回应一个SYN（SEQ=y）ACK(ACK=x+1）报文，进入SYN_RECV状态。
3. 客户端收到服务器端的SYN报文，回应一个ACK(ACK=y+1）报文，进入Established状态。

三次握手完成，TCP客户端和服务器端成功地建立连接，可以开始传输数据了。

# 0x03 会有什么问题
网络也有不稳定的时候，还有各种突发情况，使得他们之间的通信并不那么理想，总会丢失数据包。但是我们都知道TCP是可靠传输，如何保证可靠性呢，这里就要讲到TCP的超时重传了。先看看上面这三次握手中，可能会出现哪些问题：

1. 第1步SYN没发出去
2. 第2步SYN-ACK报文没收到(超时/丢失)
3. 第3步ACK没有收到(超时/丢失)
4. 第2步或者第3步收到了多个重复的报文

现在我们来分析一下：

1. 这种应该不存在。就算对方（上图的服务器方）没开机或者其他原因不可达，那么也能发出去，只是会返回一个“目的地址不可达”的ICMP报文。
2. 发送方发送SYN报文后，会启动一个定时器，如果到时间了还没有收到对方（上图的服务器方）的应答报文，则会重新发送一次SYN报文，这个的过程会持续好多次，直至收到了SYN-ACK报文或者超过了一定时间（通常为9分钟）则结束重试。
3. 跟第2个问题类似的，当第3步ACK没有收到时，第2步的SYN-ACK报文会重发。
4. 如果第一次发的报文在网络游走了很久，而没有收到对方的报文，然后就会发送第二次，然而第一次的报文也达到了（这里不分前后），那么接收方就会把后面到的报文丢掉，而不给任何回应。

# 0x04 发现了什么
从上面可以看出，三次握手中保证可靠传输用到了超时重传的思想。那么我们再平时的工作中，是否可以借鉴这种思想呢？

### 1. 支付宝支付结果通知
不知道读者是否用过支付宝手机网站支付/App支付，用户在用支付宝支付成功后，支付宝服务器会向商户服务器发送手机网站支付结果异步通知。那么问题来了，如果商户服务器那时候宕机了或者是代码出错没能正确返回期望的结果会如何呢？支付宝会不会不再通知了？那肯定不会的了，作为第三方支付的佼佼者，没那么差。支付宝会通过一定的机制在25小时以内完成8次通知，可参见[服务器异步通知页面特性](https://doc.open.alipay.com/docs/doc.htm?treeId=193&articleId=105286&docType=1#s6)。

到这儿，是不是发现跟TCP的超时重传类似，支付宝服务器向商户服务器发送通知（类似于ACK），但是商户服务器没返回正确的（也就是类似于没有SYN-ACK报文），那么支付宝服务器就会隔一段时间再发直至返回正确或者超过25小时。

这实际上是补偿机制，可简单用与A、B两系统中间的消息同步。比如商城系统同步到ERP系统，那么中间可能会出问题，那么就需要这样的补偿机制。

### 2. 接口设计
在工作，曾经遇到过这样的问题：我们跟JD有接口对接，有天有了下面的对话（K是我一同事）。
```
K：你看这个接口，我添加该商品好多次都是返回成功，这会不会是有问题？
我：说他们返回的ID有没有重复？
K：没有。
我：那就应该是只添加了一个，而不是多个。
K：为什么会这样呢？如果添加一次成功后后面的上传都返回错误不行吗？
我：那如果是JD添加成功了，但是超时了你没收到成功信息呢？会如何？你是不是会再推送一次？但是京东的已经存在该商品了，那么是返回错误给你吗？比如返回“商品已经存在”？
K：可以啊。
我：那你是不是多了个判断？而且返回错误，你还是正常处理业务，是不是不太好？如果返回成功，那不是很好？
```
上面的例子虽然不都这样处理，只是说明TCP的超时重传思想可以用到实践中去。
